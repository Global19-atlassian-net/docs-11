

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Peak detection &mdash; skimage v0.7dev docs</title>
    
    <link rel="stylesheet" href="../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.7dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/docversions.js"></script>
    <link rel="top" title="skimage v0.7dev docs" href="../../index.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
          <div class="logo"><a href="http://scikits-image.org">
            <img class="logo" src="../../_static/scikits_image_logo_small.png" alt="Logo"/>
          </a></div>
       
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
             
            
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"> 

  
    <h3>Navigation</h3>
    <p>
    <a href="../../index.html">Documentation Home</a>
    </p>
    <p>&nbsp;</p>
  
    <h3>Contents</h3>
    <ul>
<li><a class="reference internal" href="#">Peak detection</a><ul>
<li><a class="reference internal" href="#thresholding">Thresholding</a></li>
<li><a class="reference internal" href="#morphological-reconstruction">Morphological reconstruction</a></li>
<li><a class="reference internal" href="#white-tophat">White tophat</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>




  <h3>Version</h3>

    <script type="text/javascript">
      insert_version_links();
    </script>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
        
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="peak-detection">
<span id="example-applications-plot-peak-detection-comparison-py"></span><h1>Peak detection<a class="headerlink" href="#peak-detection" title="Permalink to this headline">¶</a></h1>
<p>Peak detection (a.k.a. spot detection or particle detection) is a common
image analysis step. For example, it&#8217;s used to detect tracer particles in a
flow for particle image velocimetry (i.e. PIV) and to identify features in
the Hough transform.</p>
<p>To simplify plotting code, let&#8217;s define a simple function that creates a new
figure on each call, and removes tick labels.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">&#39;axes.titlesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>To explore different peak detection techniques, we use an image of circles with
added noise:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">data</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;noisy_circles.jpg&#39;</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_1.png" src="../../_images/plot_peak_detection_comparison_1.png" />
<p>This image is noisy and has uneven background illumination. The peaks in the
image, while readily identified by eye, can be tricky to find algorithmically.
The first thing we need to do is remove the high-frequency noise; this can
be done with a simple Gaussian filter.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="kn">as</span> <span class="nn">ndimg</span>
<span class="n">img_smooth</span> <span class="o">=</span> <span class="n">ndimg</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">imshow</span><span class="p">(</span><span class="n">img_smooth</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_2.png" src="../../_images/plot_peak_detection_comparison_2.png" />
<div class="section" id="thresholding">
<h2>Thresholding<a class="headerlink" href="#thresholding" title="Permalink to this headline">¶</a></h2>
<p>One way to extract the background is to threshold the image.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">thresh_value</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">background</span> <span class="o">=</span> <span class="n">img_smooth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">background</span><span class="p">[</span><span class="n">img_smooth</span> <span class="o">&gt;</span> <span class="n">thresh_value</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">peaks</span> <span class="o">=</span> <span class="n">img_smooth</span> <span class="o">-</span> <span class="n">background</span>
</pre></div>
</div>
<p>Here, all pixels values below the threshold value are subtracted from the
image. The resulting background image and the extracted peaks are shown below.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">imshow</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;background image (thresholding)&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_3.png" src="../../_images/plot_peak_detection_comparison_3.png" />
<div class="highlight-python"><div class="highlight"><pre><span class="n">imshow</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;peaks (thresholding)&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_4.png" src="../../_images/plot_peak_detection_comparison_4.png" />
<p>Because of uneven illumination, peaks on the right bleed into each other.
Increasing the threshold will fix this problem, but it will also cause some
peaks on the left to go undetected.</p>
</div>
<div class="section" id="morphological-reconstruction">
<h2>Morphological reconstruction<a class="headerlink" href="#morphological-reconstruction" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">img_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">img_smooth</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">skimage.morphology</span> <span class="kn">as</span> <span class="nn">morph</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">rec</span> <span class="o">=</span> <span class="n">morph</span><span class="o">.</span><span class="n">reconstruction</span><span class="p">(</span><span class="n">img_r</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">img_r</span><span class="p">)</span>

<span class="n">imshow</span><span class="p">(</span><span class="n">img_r</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;original (smoothed) image&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_5.png" src="../../_images/plot_peak_detection_comparison_5.png" />
<div class="highlight-python"><div class="highlight"><pre><span class="n">imshow</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;background image (reconstruction)&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_6.png" src="../../_images/plot_peak_detection_comparison_6.png" />
<p>This reconstructed image looks pretty much like the original, except that the
peaks in the image are truncated. The reconstructed image can then be
subtracted from the original image to reveal the peaks of the image.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">imshow</span><span class="p">(</span><span class="n">img_r</span><span class="o">-</span><span class="n">rec</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;h-dome of image&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_7.png" src="../../_images/plot_peak_detection_comparison_7.png" />
<p>The result is known as the h-dome transformation <a class="footnote-reference" href="#id3" id="id1">[2]</a>, which extracts peaks of
height <cite>h</cite> from the original image. To better understand what&#8217;s going on,
let&#8217;s take a 1D slice along the middle of the image (cutting through peaks in
the image).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">img_slice</span> <span class="o">=</span> <span class="n">img_r</span><span class="p">[</span><span class="mi">99</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">rec_slice</span> <span class="o">=</span> <span class="n">morph</span><span class="o">.</span><span class="n">reconstruction</span><span class="p">(</span><span class="n">img_slice</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">img_slice</span><span class="p">)</span>
</pre></div>
</div>
<p>Plotting the reconstructed image (slice) next to the original image and the
seed image shed light on the reconstruction process</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">img_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;original image&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">img_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="s">&#39;0.5&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;seed image&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rec_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;reconstructed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;image slice&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;intensity&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_8.png" src="../../_images/plot_peak_detection_comparison_8.png" />
<p>Here, you see that morphological reconstruction dilates the seed image (i.e.
the <cite>h</cite>-shifted image) until it intersects the mask (original image). Note that
the peaks in the original image have very different intensity values (e.g. the
peak at x=200 and x=100 differ by about 80). Subtracting the reconstructed
image from the original image gives peaks of roughly equal intensity. Thus, the
h-dome transformation is quiet effective at removing uneven, dark backgrounds
from bright features. The inverse operation&#8212;the h-basin
transformation&#8212;should be used when removing bright backgrounds from dark
features.</p>
</div>
<div class="section" id="white-tophat">
<h2>White tophat<a class="headerlink" href="#white-tophat" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="n">selem</span> <span class="o">=</span> <span class="n">morph</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">img_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">img_smooth</span><span class="p">)</span>
<span class="n">opening</span> <span class="o">=</span> <span class="n">morph</span><span class="o">.</span><span class="n">greyscale_open</span><span class="p">(</span><span class="n">img_t</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
<span class="n">top_hat</span> <span class="o">=</span> <span class="n">img_t</span> <span class="o">-</span> <span class="n">opening</span>

<span class="n">imshow</span><span class="p">(</span><span class="n">opening</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Greyscale opening of image&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_9.png" src="../../_images/plot_peak_detection_comparison_9.png" />
<div class="highlight-python"><div class="highlight"><pre><span class="n">imshow</span><span class="p">(</span><span class="n">top_hat</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Tophat with disk of r = 10&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_10.png" src="../../_images/plot_peak_detection_comparison_10.png" />
<div class="highlight-python"><div class="highlight"><pre><span class="n">selem</span> <span class="o">=</span> <span class="n">morph</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">top_hat</span> <span class="o">=</span> <span class="n">morph</span><span class="o">.</span><span class="n">greyscale_white_top_hat</span><span class="p">(</span><span class="n">img_t</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>

<span class="n">imshow</span><span class="p">(</span><span class="n">top_hat</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Tophat with disk of r = 5&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_11.png" src="../../_images/plot_peak_detection_comparison_11.png" />
<div class="highlight-python"><div class="highlight"><pre><span class="n">selem</span> <span class="o">=</span> <span class="n">morph</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">opening</span> <span class="o">=</span> <span class="n">morph</span><span class="o">.</span><span class="n">greyscale_open</span><span class="p">(</span><span class="n">img_t</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
<span class="c"># scikit&#39;s top hat filter uses uint8 and doesn&#39;t check for over(under)flow.</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">opening</span> <span class="o">&gt;</span> <span class="n">img_t</span>
<span class="n">opening</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_t</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">top_hat</span> <span class="o">=</span> <span class="n">img_t</span> <span class="o">-</span> <span class="n">opening</span>

<span class="n">imshow</span><span class="p">(</span><span class="n">opening</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Greyscale opening of image&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_12.png" src="../../_images/plot_peak_detection_comparison_12.png" />
<div class="highlight-python"><div class="highlight"><pre><span class="n">imshow</span><span class="p">(</span><span class="n">top_hat</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Tophat with square of w = 10&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/plot_peak_detection_comparison_13.png" src="../../_images/plot_peak_detection_comparison_13.png" />
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td>Crocker and Grier, Journal of Colloid and Interface Science (1996)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[2]</a></td><td>Vincent, L., IEEE Transactions on Image Processing (1993)</td></tr>
</tbody>
</table>
<p><strong>Python source code:</strong> <a class="reference download internal" href="../../_downloads/plot_peak_detection_comparison.py"><tt class="xref download docutils literal"><span class="pre">download</span></tt></a>
(generated using <tt class="docutils literal"><span class="pre">skimage</span></tt> 0.7dev)</p>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="clearer"></div>
    </div>
    </div>

    <div class="footer-wrapper">
      
    <div class="footer">
        &copy; Copyright 2011, the scikits-image team.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
    </div>

  </body>
</html>